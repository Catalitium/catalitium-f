{% extends "base.html" %}
{% block title %}Catalitium — Jobs{% endblock %}

{% block content %}
<!-- HERO -->
<section class="pt-6 sm:pt-10" role="region" aria-labelledby="jobs-hero">
  <div class="mx-auto max-w-4xl text-center">
    <h1 id="jobs-hero" class="text-3xl sm:text-4xl font-semibold tracking-tight">
      Find your next <span class="text-brand">high-paying</span> role
    </h1>
    <p class="mt-3 text-slate-600">Search by title and country/region. Results update on submit.</p>
  </div>

  <!-- SEARCH: What / Where -->
  <form id="search"
        action="{{ url_for('index') }}"
        method="get"
        aria-label="Job search"
        class="mx-auto mt-6 max-w-4xl grid grid-cols-1 sm:grid-cols-[1fr_240px_auto] gap-3"
        data-results-count="{{ count|default(0) }}">
    <label for="q" class="sr-only">Job title or keywords</label>
    <input id="q"
           name="title"
           value="{{ title_q or '' }}"
           type="search"
           autocomplete="off"
           placeholder="What (e.g., Software Engineer, PM, Data, “>100k”, “80k-120k”)"
           class="w-full rounded-xl border border-slate-300 px-4 py-3 focus:ring-2 focus:ring-brand/50 focus:outline-none">

    <label for="loc" class="sr-only">Country / region</label>
    <input id="loc"
           name="country"
           value="{{ country_q or '' }}"
           type="search"
           autocomplete="off"
           placeholder="Where (e.g., DE, EU, Schweiz)"
           class="w-full rounded-xl border border-slate-300 px-4 py-3 focus:ring-2 focus:ring-brand/50 focus:outline-none">

    <button type="submit"
            class="rounded-xl bg-brand text-white px-5 py-3 hover:opacity-90 transition">
      Search
    </button>
  </form>

  <!-- META / FILTERS -->
  <div class="mx-auto max-w-4xl mt-3 flex items-center justify-between gap-3 text-xs text-slate-500">
    <div class="flex items-center gap-2 flex-wrap">
      <span>{{ count|default(0) }} result{{ '' if count==1 else 's' }}</span>

      {% if title_q or country_q %}
        <span>•</span>
        {% if title_q %}
          <span class="rounded-full bg-slate-100 px-2 py-0.5 border border-slate-200">title: “{{ title_q }}”</span>
        {% endif %}
        {% if country_q %}
          <span class="rounded-full bg-slate-100 px-2 py-0.5 border border-slate-200">country: “{{ country_q }}”</span>
        {% endif %}
        <a class="ml-2 underline hover:text-brand" href="{{ url_for('index') }}">Clear</a>
      {% endif %}
    </div>

    <!-- Subscribe toggle -->
    <label for="weekly-toggle" class="flex items-center gap-2 cursor-pointer select-none">
      <input id="weekly-toggle"
             type="checkbox"
             class="peer sr-only"
             aria-controls="subscribeDialog"
             aria-describedby="weekly-help">
      <span class="relative inline-flex h-5 w-9 items-center rounded-full bg-slate-300 peer-checked:bg-brand transition">
        <span class="absolute left-1 peer-checked:left-5 inline-block h-4 w-4 rounded-full bg-white shadow transition"></span>
      </span>
      <span class="text-slate-700">Get weekly job reminders</span>
    </label>
  </div>
  <p id="weekly-help"
     class="mx-auto max-w-4xl mt-1 text-[11px] text-right text-slate-500">
    One concise email per week. No spam.
  </p>
</section>
<!-- RESULTS LIST -->
<section class="mx-auto max-w-4xl mt-6" aria-label="Job results">
  <div class="grid grid-cols-1 gap-3">
    {% set CUR = {'EUR':'€','USD':'$','GBP':'£','CHF':'CHF'} %}
    <!-- Sponsored job slot (reserved) -->
    <div class="rounded-xl border border-amber-300/60 bg-amber-50 p-4 text-amber-800">
      <div class="text-xs uppercase tracking-wide font-semibold">Sponsored</div>
      <p class="text-sm">Your job here. Reach top talent. <a href="#" class="underline" data-open-subscribe>Contact us</a>.</p>
    </div>
    {% for j in results or [] %}
    <article class="rounded-xl border border-slate-200 p-4 hover:border-slate-300 transition-colors"
             data-job-id="{{ j.id }}">
      <header class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <h2 class="text-base font-semibold leading-tight truncate">{{ j.title }}</h2>
          <p class="text-slate-600 text-xs mt-0.5 truncate">
            {{ j.company }} • {{ j.location }}
          </p>
        </div>
      </header>

      <!-- Salary & reference -->
      <div class="mt-2 text-[11px] text-slate-600 flex items-center gap-3 flex-wrap">
        {% set offer_mid = None %}
        {% if j.salary_min or j.salary_max %}
          {% set offer_min = j.salary_min or j.salary_max %}
          {% set offer_max = j.salary_max or j.salary_min %}
          {% set offer_mid = (offer_min + offer_max) / 2 %}
          <span aria-label="Offered salary">
            💰 {{ '{:,}'.format(offer_min) }}{% if j.salary_max %}–{{ '{:,}'.format(offer_max) }}{% endif %}
          </span>
        {% endif %}

        {% if j.ref_median or j.ref_min %}
          {% set ref_sym = CUR.get(j.ref_currency or '', j.ref_currency or '') %}
          <span class="text-slate-500">
            📊 Ref{% if j.ref_match_label %} ({{ j.ref_match_label }}){% endif %}:
            {% if j.ref_median %} {{ ref_sym }}{{ '{:,}'.format(j.ref_median) }} median{% endif %}
            {% if j.ref_min %} • Min: {{ ref_sym }}{{ '{:,}'.format(j.ref_min) }}{% endif %}
          </span>

          {% if offer_mid and j.ref_median %}
            {% set delta = ((offer_mid - j.ref_median) / j.ref_median * 100) | round(0, 'floor') %}
            <span class="px-1.5 py-0.5 rounded-md border text-[10px]
                         {% if delta >= 0 %} border-emerald-300/60 bg-emerald-50 text-emerald-700
                         {% else %} border-amber-300/60 bg-amber-50 text-amber-700 {% endif %}">
              {% if delta >= 0 %}+{% endif %}{{ delta }}% vs ref
            </span>
          {% endif %}
        {% endif %}

        {% if j.date_posted %}
          <span class="text-slate-500">📅 {{ j.date_posted }}</span>
        {% endif %}
      </div>

      <!-- Details toggle -->
      <div class="mt-2">
        <button type="button"
                class="text-[12px] underline hover:text-brand"
                data-toggle="details"
                aria-expanded="false">
          Details
        </button>
        <div class="mt-2 hidden" data-details>
          <p class="text-sm text-slate-700 whitespace-pre-line">{{ j.description }}</p>
        </div>
      </div>
    </article>
    {% else %}
    <div class="rounded-xl border border-slate-200 p-6 text-slate-600 text-center">
      <p class="font-medium">No jobs found.</p>
      <p class="text-xs mt-1">Try broader keywords (e.g., “engineer”, “pm”) or another region (e.g., “DE”, “EU”).</p>
    </div>
    {% endfor %}
  </div>
</section>

<!-- Pagination -->
{% if pagination and (pagination.has_prev or pagination.has_next) %}
<nav class="mx-auto max-w-4xl mt-4 flex items-center justify-between text-sm"
     role="navigation" aria-label="Pagination">
  <a class="px-3 py-2 rounded-lg border border-slate-200 hover:border-brand {{ '' if pagination.has_prev else 'pointer-events-none opacity-50' }}"
     href="{{ pagination.prev_url or '#' }}">← Prev</a>
  <span class="text-slate-500">
    Page {{ pagination.page }} of {{ pagination.pages }} • {{ pagination.total }} total
  </span>
  <a class="px-3 py-2 rounded-lg border border-slate-200 hover:border-brand {{ '' if pagination.has_next else 'pointer-events-none opacity-50' }}"
     href="{{ pagination.next_url or '#' }}">Next →
  </a>
</nav>
{% endif %}

<!-- Subscribe dialog is defined globally in base.html -->
{% endblock %}

{% block body_extra %}
<script>
(() => {
  const form = document.getElementById('search');
  const q = document.getElementById('q');
  const loc = document.getElementById('loc');
  const toggle = document.getElementById('weekly-toggle');
  const dlg = document.getElementById('subscribeDialog');

  // Normalize input (matches server logic)
  const COUNTRY_MAP = { de:"DE", deu:"DE", germany:"DE", deutschland:"DE", ch:"CH", schweiz:"CH", suisse:"CH", svizzera:"CH", switzerland:"CH", at:"AT", österreich:"AT", austria:"AT", eu:"EU", europe:"EU", uk:"UK", gb:"UK", england:"UK", "united kingdom":"UK", us:"US", usa:"US", "united states":"US", america:"US", es:"ES", spain:"ES", fr:"FR", france:"FR", it:"IT", italy:"IT", nl:"NL", netherlands:"NL", be:"BE", belgium:"BE", se:"SE", sweden:"SE", pl:"PL", poland:"PL", co:"CO", colombia:"CO", mx:"MX", mexico:"MX" };
  const TITLE_MAP = { swe:"software engineer", "software eng":"software engineer", "sw eng":"software engineer", frontend:"front end", "front-end":"front end", backend:"back end", "back-end":"back end", fullstack:"full stack", "full-stack":"full stack", pm:"product manager", "prod mgr":"product manager", "product owner":"product manager", ds:"data scientist", ml:"machine learning", mle:"machine learning engineer", sre:"site reliability engineer", devops:"devops", "sec eng":"security engineer", infosec:"security" };

  const normCountry = v => { if (!v) return ""; const t = v.trim().toLowerCase(); if (COUNTRY_MAP[t]) return COUNTRY_MAP[t]; if (/^[a-z]{2}$/.test(t)) return t.toUpperCase(); return v.trim(); };
  const normTitle = v => { if (!v) return ""; let s = v.toLowerCase(); Object.entries(TITLE_MAP).forEach(([k, val]) => { if (s.includes(k)) s = s.replace(new RegExp(k,"g"), val); }); return s.replace(/\s+/g," ").trim(); };

  // Submit normalization + GTM event
  form?.addEventListener('submit', () => {
    q.value = normTitle(q.value);
    loc.value = normCountry(loc.value);
    window.dispatchEvent(new CustomEvent('jobs:search', { detail: { search_term: q.value, country: loc.value, results_count: Number(form.dataset.resultsCount||0), source: 'form' } }));
  });

  // Weekly toggle → subscribe modal
  if (toggle && dlg && dlg.showModal) {
    toggle.addEventListener('change', () => { if (toggle.checked) { dlg.showModal(); document.getElementById('subscribe-email')?.focus(); }});
    dlg.addEventListener('close', () => { toggle.checked = false; });
    dlg.addEventListener('click', e => { const r = dlg.getBoundingClientRect(); if (e.clientX<r.left||e.clientX>r.right||e.clientY<r.top||e.clientY>r.bottom) dlg.close(); });
  }

  // Job details toggle
  document.querySelectorAll('[data-toggle="details"]').forEach(btn => {
    let opened = false;
    btn.addEventListener('click', () => {
      const container = btn.closest('article')?.querySelector('[data-details]');
      if (!container) return;
      container.classList.toggle('hidden');
      const expanded = !container.classList.contains('hidden');
      btn.setAttribute('aria-expanded', expanded);
      if (expanded && !opened) {
        opened = true;
        window.dispatchEvent(new CustomEvent('jobs:view', { detail: { job_title: btn.dataset.jobTitle, company: btn.dataset.company }}));
        try {
          const art = btn.closest('article');
          const id = art?.getAttribute('data-job-id');
          const company = art?.querySelector('.text-slate-600')?.textContent || '';
          const title = art?.querySelector('h2')?.textContent || '';
          const location = company.split('•')[1] || '';
          fetch('/events/job_view', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ job_id: id, job_title: title, company: company.split('•')[0]?.trim() || '', location: location.trim() })}).catch(()=>{});
        } catch(e){}
      }
    });
  });

  // Links that open the subscribe modal
  document.querySelectorAll('[data-open-subscribe]').forEach(el => {
    el.addEventListener('click', e => { e.preventDefault(); dlg?.showModal(); document.getElementById('subscribe-email')?.focus(); });
  });
})();
</script>
{% endblock %}