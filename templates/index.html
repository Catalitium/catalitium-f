{% extends "base.html" %}
{% block title %}Catalitium â€” Jobs{% endblock %}

{% block content %}
<!-- HERO -->
<section class="pt-6 sm:pt-10">
  <div class="mx-auto max-w-4xl">
    <h1 class="text-3xl sm:text-4xl font-semibold tracking-tight text-center">
      Find your next <span class="text-brand">high-paying</span> role
    </h1>
    <p class="mt-3 text-slate-600 text-center">Search by title and country/region. Results update on submit.</p>
  </div>

  <!-- SEARCH: What / Where -->
  <form id="search" action="{{ url_for('index') }}" method="get"
        class="mx-auto mt-6 max-w-4xl grid grid-cols-1 sm:grid-cols-[1fr_240px_auto] gap-3"
        data-results-count="{{ count|default(0) }}">
    <label for="q" class="sr-only">Job title or keywords</label>
    <input id="q" name="title" value="{{ title_q or '' }}" autocomplete="off"
           placeholder="What (e.g., Software Engineer, PM, Data, â€œ>100kâ€, â€œ80k-120kâ€)"
           class="w-full rounded-xl border border-slate-300 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-brand/50">

    <label for="loc" class="sr-only">Country / region</label>
    <input id="loc" name="country" value="{{ country_q or '' }}" autocomplete="off"
           placeholder="Where (e.g., DE, EU, Schweiz)"
           class="w-full rounded-xl border border-slate-300 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-brand/50">

    <button type="submit"
            class="rounded-xl bg-brand text-white px-5 py-3 hover:opacity-90">Search</button>
  </form>

  <!-- META / FILTERS + Subtle reminders toggle -->
  <div class="mx-auto max-w-4xl mt-3 flex items-center justify-between gap-3 text-xs text-slate-500">
    <div class="flex items-center gap-2 flex-wrap">
      <span>{{ count|default(0) }} result{{ '' if count==1 else 's' }}</span>
      {% if title_q or country_q %}
        <span>â€¢</span>
        {% if title_q %}
          <span class="rounded-full bg-slate-100 px-2 py-0.5 border border-slate-200">title: â€œ{{ title_q }}â€</span>
        {% endif %}
        {% if country_q %}
          <span class="rounded-full bg-slate-100 px-2 py-0.5 border border-slate-200">country: â€œ{{ country_q }}â€</span>
        {% endif %}
        <a class="ml-2 underline hover:text-brand" href="{{ url_for('index') }}">Clear</a>
      {% endif %}
    </div>

    <label for="weekly-toggle" class="flex items-center gap-2 cursor-pointer select-none">
      <input id="weekly-toggle" type="checkbox" class="peer sr-only" aria-controls="subscribeDialog" aria-describedby="weekly-help">
      <span class="relative inline-flex h-5 w-9 items-center rounded-full bg-slate-300 peer-checked:bg-brand transition">
        <span class="absolute left-1 peer-checked:left-5 inline-block h-4 w-4 rounded-full bg-white shadow transition"></span>
      </span>
      <span class="text-slate-700">Get weekly job reminders</span>
    </label>
  </div>
  <p id="weekly-help" class="mx-auto max-w-4xl mt-1 text-[11px] text-right text-slate-500">
    One concise email per week. No spam.
  </p>
</section>

<!-- RESULTS LIST -->
<section class="mx-auto max-w-4xl mt-6">
  <div class="grid grid-cols-1 gap-3">
    {% set CUR = {'EUR':'â‚¬','USD':'$','GBP':'Â£','CHF':'CHF'} %}
    {% for j in results or [] %}
    <article class="rounded-xl border border-slate-200 p-4 hover:border-slate-300 transition-colors">
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <h2 class="text-base font-semibold leading-tight truncate">{{ j.title }}</h2>
          <p class="text-slate-600 text-xs mt-0.5 truncate">
            {{ j.company }} â€¢ {{ j.location }}
          </p>
        </div>
      </div>

      <!-- Salary: offered, reference (Cityâ†’Countryâ†’Global), and delta -->
      <div class="mt-2 text-[11px] text-slate-600 flex items-center gap-3 flex-wrap">
        {% set offer_mid = None %}
        {% if j.salary_min or j.salary_max %}
          {% set offer_min = j.salary_min or j.salary_max %}
          {% set offer_max = j.salary_max or j.salary_min %}
          {% set offer_mid = (offer_min + offer_max) / 2 %}
          <span>ğŸ’° {{ '{:,}'.format(offer_min) }}{% if j.salary_max %}â€“{{ '{:,}'.format(offer_max) }}{% endif %}</span>
        {% endif %}

        {% if j.ref_median or j.ref_min %}
          {% set ref_sym = CUR.get(j.ref_currency or '', j.ref_currency or '') %}
          <span class="text-slate-500">
            ğŸ“Š Ref{% if j.ref_match_label %} ({{ j.ref_match_label }}){% endif %}:
            {% if j.ref_median %} {{ ref_sym }}{{ '{:,}'.format(j.ref_median) }} median{% endif %}
            {% if j.ref_min %} â€¢ Min: {{ ref_sym }}{{ '{:,}'.format(j.ref_min) }}{% endif %}
          </span>

          {% if offer_mid and j.ref_median %}
            {% set delta = ((offer_mid - j.ref_median) / j.ref_median * 100) | round(0, 'floor') %}
            <span class="px-1.5 py-0.5 rounded-md border text-[10px]
                         {% if delta >= 0 %} border-emerald-300/60 bg-emerald-50 text-emerald-700
                         {% else %} border-amber-300/60 bg-amber-50 text-amber-700 {% endif %}">
              {% if delta >= 0 %}+{% endif %}{{ delta }}% vs ref
            </span>
          {% endif %}
        {% endif %}

        {% if j.date_posted %}<span class="text-slate-500">ğŸ“… {{ j.date_posted }}</span>{% endif %}
      </div>

      <div class="mt-2">
        <button type="button"
                class="text-[12px] underline hover:text-brand"
                data-toggle="details"
                data-job-id="{{ j.id }}"
                data-job-title="{{ j.title }}"
                data-company="{{ j.company }}">
          Details
        </button>
        <div class="mt-2 hidden" data-details-for="{{ j.id }}">
          <p class="text-sm text-slate-700 whitespace-pre-line">{{ j.description }}</p>
        </div>
      </div>
    </article>
    {% else %}
    <div class="rounded-xl border border-slate-200 p-6 text-slate-600 text-center">
      <p class="font-medium">No jobs found.</p>
      <p class="text-xs mt-1">Try broader keywords (e.g., â€œengineerâ€, â€œpmâ€) or another region (e.g., â€œDEâ€, â€œEUâ€).</p>
    </div>
    {% endfor %}
  </div>
</section>

<!-- Pagination -->
{% if pagination and (pagination.has_prev or pagination.has_next) %}
<nav class="mx-auto max-w-4xl mt-4 flex items-center justify-between text-sm">
  <a class="px-3 py-2 rounded-lg border border-slate-200 hover:border-brand {{ '' if pagination.has_prev else 'pointer-events-none opacity-50' }}"
     href="{{ pagination.prev_url or '#' }}">â† Prev</a>
  <span class="text-slate-500">Page {{ pagination.page }} of {{ pagination.pages }} â€¢ {{ pagination.total }} total</span>
  <a class="px-3 py-2 rounded-lg border border-slate-200 hover:border-brand {{ '' if pagination.has_next else 'pointer-events-none opacity-50' }}"
     href="{{ pagination.next_url or '#' }}">Next â†’</a>
</nav>
{% endif %}

<!-- Minimal subscribe dialog (conversion-focused) -->
<dialog id="subscribeDialog" class="rounded-2xl p-0 backdrop:bg-slate-900/40">
  <form method="dialog" class="absolute right-3 top-3">
    <button aria-label="Close dialog"
            class="rounded-lg border border-slate-200 px-2 py-1 text-slate-600 hover:text-slate-900 hover:border-slate-300">âœ•</button>
  </form>
  <div class="p-6 sm:p-7 w-[90vw] max-w-md">
    <div class="flex items-center gap-2">
      <span class="inline-grid place-items-center w-9 h-9 rounded-full bg-brand text-white font-semibold">C</span>
      <h2 class="text-lg font-semibold">Weekly job reminders</h2>
    </div>
    <p class="mt-2 text-slate-600 text-sm">One tidy email with new high-signal roles. Unsubscribe anytime.</p>

    <form action="{{ url_for('subscribe') }}" method="post"
          class="mt-5 grid grid-cols-1 sm:grid-cols-[1fr_auto] gap-3">
      <label for="subscribe-email" class="sr-only">Email</label>
      <input id="subscribe-email" name="email" type="email" required autocomplete="email"
             placeholder="you@company.com"
             class="w-full rounded-xl border border-slate-300 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-brand/50">
      <button type="submit" class="inline-flex justify-center rounded-xl bg-brand text-white px-5 py-3 hover:opacity-90">
        Subscribe
      </button>
    </form>

    <p class="mt-2 text-[11px] text-slate-500">Privacy-friendly. Weâ€™ll only email once a week.</p>
  </div>
</dialog>
{% endblock %}

{% block body_extra %}
<script>
  (function() {
    // --- Normalization mirrors server (light) ---
    var form = document.getElementById('search');
    var q = document.getElementById('q');
    var loc = document.getElementById('loc');

    var COUNTRY_MAP = {
      "de":"DE","deu":"DE","germany":"DE","deutschland":"DE",
      "ch":"CH","schweiz":"CH","suisse":"CH","svizzera":"CH","switzerland":"CH",
      "at":"AT","Ã¶sterreich":"AT","austria":"AT",
      "eu":"EU","europe":"EU",
      "uk":"UK","gb":"UK","england":"UK","united kingdom":"UK",
      "us":"US","usa":"US","united states":"US","america":"US"
    };
    var TITLE_MAP = {
      "swe":"software engineer","software eng":"software engineer","sw eng":"software engineer",
      "frontend":"front end","backend":"back end","fullstack":"full stack",
      "pm":"product manager","ds":"data scientist","ml":"machine learning",
      "mle":"machine learning engineer","sre":"site reliability engineer","devops":"devops"
    };

    function normCountry(v){
      if(!v) return "";
      var t=v.trim().toLowerCase();
      if(COUNTRY_MAP[t]) return COUNTRY_MAP[t];
      if(/^[a-z]{2}$/.test(t)) return t.toUpperCase();
      return v.trim();
    }
    function normTitle(v){
      if(!v) return "";
      var s=v.toLowerCase();
      Object.keys(TITLE_MAP).forEach(function(k){ if(s.includes(k)) s=s.replace(new RegExp(k,'g'),TITLE_MAP[k]); });
      return s.replace(/\s+/g,' ').trim();
    }

    // GTM-friendly events on load & submit
    var params = new URLSearchParams(window.location.search);
    var tq = (params.get('title') || '').trim();
    var cq = (params.get('country') || '').trim();
    var rc = Number(form.dataset.resultsCount || 0);
    if (tq || cq) {
      window.dispatchEvent(new CustomEvent('jobs:search', {
        detail: { search_term: tq, country: cq, results_count: rc, source: 'url' }
      }));
    }
    form.addEventListener('submit', function(){
      var nt = normTitle(q.value), nc = normCountry(loc.value);
      q.value = nt; loc.value = nc;
      // ensure page resets to 1 on new search
      (new URL(window.location)).searchParams.set('page', '1');
      window.dispatchEvent(new CustomEvent('jobs:search', {
        detail: { search_term: nt, country: nc, results_count: rc, source: 'form' }
      }));
    });

    // Subtle reminders toggle â†’ open dialog
    var toggle = document.getElementById('weekly-toggle');
    var dlg = document.getElementById('subscribeDialog');
    if (toggle && dlg && dlg.showModal) {
      toggle.addEventListener('change', function() {
        if (toggle.checked) {
          dlg.showModal();
          document.getElementById('subscribe-email')?.focus();
        }
      });
      // close on backdrop click
      dlg.addEventListener('click', function(e){
        var r = dlg.getBoundingClientRect();
        var inside = e.clientX>=r.left && e.clientX<=r.right && e.clientY>=r.top && e.clientY<=r.bottom;
        if (!inside) dlg.close();
      });
      // reset toggle when dialog closes
      dlg.addEventListener('close', function(){ toggle.checked = false; });
    }

    // Expand details + fire job_view once
    document.querySelectorAll('[data-toggle="details"]').forEach(function(btn){
      var opened=false;
      btn.addEventListener('click', function(){
        var id = btn.getAttribute('data-job-id');
        var body = document.querySelector('[data-details-for="'+id+'"]');
        if(!body) return;
        var wasHidden = body.classList.contains('hidden');
        body.classList.toggle('hidden');
        if(wasHidden && !opened){
          opened=true;
          window.dispatchEvent(new CustomEvent('jobs:view', {
            detail: { job_id:Number(id), job_title:btn.getAttribute('data-job-title'), company:btn.getAttribute('data-company') }
          }));
        }
      });
    });
  })();

      // Nav/footer links â†’ open same subscribe modal
    document.querySelectorAll('[data-open-subscribe]').forEach(function(el){
      el.addEventListener('click', function(e){
        e.preventDefault();
        if (dlg && dlg.showModal) {
          dlg.showModal();
          document.getElementById('subscribe-email')?.focus();
        }
      });
    });

</script>
{% endblock %}